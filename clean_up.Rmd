---
title: "Aortic valve analysis"
author: "Steve Simon"
date: "May 25, 2017"
output: html_document
---


```{r preliminaries}
source("prelims.R", echo=FALSE)
av1 <- read.csv("av1_2017_05_29.csv", as.is=TRUE)
av3 <- read.csv("av3_2017_05_29.csv", as.is=TRUE)
av4 <- read.csv("av4_2017_05_29.csv", as.is=TRUE)

mv1 <- read.csv("mv1_2017_05_29.csv", as.is=TRUE)
mv4 <- read.csv("mv4_2017_05_29.csv", as.is=TRUE)


names(av1) %<>% clean_up_names
names(av3) %<>% clean_up_names
names(av4) %<>% clean_up_names

names(mv1) %<>% clean_up_names
names(mv4) %<>% clean_up_names

av1 <- remove_empty_space(av1)
av3 <- remove_empty_space(av3)
av4 <- remove_empty_space(av4)

mv1 <- remove_empty_space(mv1)
mv4 <- remove_empty_space(mv4)

av1 <- check_ids(av1)
av3 <- check_ids(av3)
av4 <- check_ids(av4)

mv1 <- check_ids(mv1)
mv4 <- check_ids(mv4)

{
  cat("\n\n\n\n**** Note new codes: ")
  cat("998 (was 888), ")
  cat("997 (was blank), ")
  cat("996 (was missing), ")
  cat("995 (unfixable)")
  cat("\n\n")
}

av1 <- loop_through_dates(av1)
av3 <- loop_through_dates(av3)
av4 <- loop_through_dates(av4)

mv1 <- loop_through_dates(mv1)
mv4 <- loop_through_dates(mv4)

print(dim(av1)[1])
print(dim(av3)[1])
print(dim(av4)[1])

print(length(intersect(av1$id, av3$id)))
print(length(intersect(av1$id, av4$id)))
print(length(intersect(av3$id, av4$id)))
print(setdiff(av3$id, av1$id))

print(dim(mv1)[1])
print(dim(mv4)[1])

print(length(intersect(mv1$id, mv4$id)))
print(setdiff(mv4$id, mv1$id))
```

AORTIC
 
1.	Arithmetic data for columns where possible – mean, median, SD, range

2.	What is the long-term survival of children with AVR?

3.	Head to head comparison of Ross versus Bio prosthesis versus Mechanical prosthesis looking at survival within the 3 groups  ==>
`r names(av1)[23]` and relation to following
 
* Age at 1st AVR ==> 
`r names(av1)[16]` MINUS
`r names(av1)[ 2]`
* Weight at 1st AVR ==>
`r names(av1)[18]`
* Valve type at 1st AVR ==>
`r names(av1)[14]` AND 
`r names(av1)[20]`
* Valve size at 1st AVR ==>
`r names(av1)[19]`
* Underlying disease ==> 
`r names(av1)[13]`
* Underlying hemodynamic mechanism – AR versus AS versus both ==> 
`r names(av1)[15]`
* Perfusion time ==> 
`r names(av1)[21]`
* Concomitant prosthetic MVR ==> 
`r names(av1)[22]`
* Initial Hospital length of stay ==> 
`r names(av1)[17]` MINUS 
`r names(av1)[16]`
* Era effect - < 1990 versus 1990s and up to 2003 ==>
`r names(av1)[16]`
* Geography – State ==> 
`r names(av1)[6]`
* Institution

4.	Causes of death – Big piles only

5.	Early deaths (PCCC) versus late deaths (NDI) – compare profiles

6.	Interactions

7.	Confounders – collinearity

8.	Kaplan Meir – Ross versus Bio versus Mechanical AVR

9.	Competing risk – will think thru this some more

10.	Redo stuff – we may not have time for this before abstract deadline

```{r kaplan-meier}
av4                                             %>%
  select(id, date_of_death)                     %>%
  right_join(av1)                               -> av5
dim(av1)
dim(av5)
valid_initial_date <- is.finite(mdy(av5$date_of_valve_replacement))
av5 <- av5[valid_initial_date, ]
dim(av5)

d0 <- mdy(av5$date_of_valve_replacement)   - mdy("1/1/1950")
d1 <- mdy(av5$ndi_date_of_death)           - mdy("1/1/1950")
d2 <- mdy(av5$date_of_death)               - mdy("1/1/1950")
d3 <- pmax(d1, d2, na.rm=TRUE)
d4 <- mdy("12/30/2014")                    - mdy("1/1/1950")
d5 <- mdy(av5$date_of_valve_replacement_1) - mdy("1/1/1950")

table(av5$ndi_date_of_death[is.na(d1)])
table(av5$date_of_death[is.na(d2)])
table(is.finite(d1), is.finite(d2))

c3 <- as.numeric(d3-d0) / 365.25
c4 <- as.numeric(d4-d0) / 365.25
censor <- as.numeric(is.finite(c3))
table(censor)
c3[censor==0] <- c4[censor==0]
av_su <- Surv(time=round(c3, 4), event=censor)
plot(survfit(av_su~1))

c5 <- as.numeric(d5-d0) / 365.25
censor <- as.numeric(is.finite(c5))
table(censor)
c5[censor==0] <- c3[censor==0]
av_su1 <- Surv(time=round(c5, 4), event=censor)
plot(survfit(av_su1~1))

mv5 <- mv1
valid_initial_date <- is.finite(mdy(mv5$date_of_valve_replacement))
mv5 <- mv5[valid_initial_date, ]
dim(mv5)

d0 <- mdy(mv5$date_of_valve_replacement)   - mdy("1/1/1950")
d3 <- mdy(mv5$ndi_date_of_death)           - mdy("1/1/1950")
d4 <- mdy("12/30/2014")                    - mdy("1/1/1950")
d5 <- mdy(mv5$date_of_valve_replacement_1) - mdy("1/1/1950")

table(mv5$ndi_date_of_death[is.na(d1)])
table(mv5$date_of_death[is.na(d2)])
table(is.finite(d1), is.finite(d2))

c3 <- as.numeric(d3-d0) / 365.25
c4 <- as.numeric(d4-d0) / 365.25
censor <- as.numeric(is.finite(c3))
table(censor)
c3[censor==0] <- c4[censor==0]
mv_su <- Surv(time=round(c3, 4), event=censor)
plot(survfit(mv_su~1))

c5 <- as.numeric(d5-d0) / 365.25
censor <- as.numeric(is.finite(c5))
table(censor)
c5[censor==0] <- c3[censor==0]
mv_su1 <- Surv(time=round(c5, 4), event=censor)
plot(survfit(mv_su1~1))

```


```{r save-everything, echo=FALSE}
save.image("clean_up.RData")
```